-- Trigger#1 to keep track of new users in the new_user_addition table

DELIMITER //

CREATE TRIGGER add_user_to_new_user_addition
AFTER INSERT ON USERS
FOR EACH ROW
BEGIN
    INSERT INTO new_user_addition (USER_ID, EMAIL, PHONE_NUMBER, ROLE, REGISTRATION_DATE)
    VALUES (NEW.USER_ID, NEW.EMAIL, NEW.PHONE_NUMBER, NEW.ROLE, NOW());
END//

DELIMITER ;


-- Trigger#2 to add to the admin table whenever a new user who is an admin registers

DELIMITER //

CREATE TRIGGER add_admin_to_admin_table
AFTER INSERT ON users
FOR EACH ROW
BEGIN
    IF NEW.ROLE = 'admin' THEN
        INSERT INTO admin (ADMIN_ID, passwd) VALUES (NEW.USER_ID, NEW.passwd);
    END IF;
END//

DELIMITER ;

DELIMITER //

CREATE TRIGGER calculate_driver_rating
AFTER INSERT ON RIDE
FOR EACH ROW
BEGIN
    DECLARE total_ratings INT;
    DECLARE total_rides INT;
    DECLARE avg_rating FLOAT;
    
    SELECT COUNT(DISTINCT RIDE_ID) INTO total_rides FROM RIDE WHERE DRIVER_ID = NEW.DRIVER_ID;
    SELECT SUM(DRIVER_RATING) INTO total_ratings FROM DRIVER WHERE DRIVER_ID = NEW.DRIVER_ID;
    
    SET avg_rating = total_ratings / total_rides;
    
    UPDATE DRIVER SET DRIVER_RATING = avg_rating WHERE DRIVER_ID = NEW.DRIVER_ID;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER update_vehicle_count
AFTER INSERT ON VEHICLE
FOR EACH ROW
BEGIN
    UPDATE DRIVER SET NUMBER_OF_VEHICLES = NUMBER_OF_VEHICLES + 1 WHERE DRIVER_ID = NEW.DRIVER_ID;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER check_payment_method
BEFORE INSERT ON CUSTOMER
FOR EACH ROW
BEGIN
    IF NEW.PAYMENT_METHOD NOT IN ('Credit Card', 'Debit Card', 'Cash') THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid payment method';
    END IF;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER new_user_notification
AFTER INSERT ON new_user_addition
FOR EACH ROW
BEGIN
    INSERT INTO ADMIN_NOTIFICATION (MESSAGE) VALUES ('New user registered: ' || NEW.USER_ID);
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER calculate_ride_distance
BEFORE INSERT ON RIDE
FOR EACH ROW
BEGIN
    DECLARE distance INT;
    
    -- Your distance calculation logic here
    
    SET NEW.RIDE_DISTANCE = distance;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER admin_access_log
AFTER INSERT ON ADMIN
FOR EACH ROW
BEGIN
    INSERT INTO ADMIN_ACCESS_LOG (ADMIN_ID, ACCESS_TIME) VALUES (NEW.ADMIN_ID, NOW());
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER award_loyalty_points
AFTER INSERT ON RIDE
FOR EACH ROW
BEGIN
    DECLARE loyalty_points INT;
    
    -- Your loyalty points calculation logic here
    
    UPDATE CUSTOMER SET LOYALTY_POINTS = LOYALTY_POINTS + loyalty_points WHERE CUSTOMER_ID = NEW.CUSTOMER_ID;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER award_driver_bonus
AFTER INSERT ON RIDE
FOR EACH ROW
BEGIN
    IF NEW.DRIVER_RATING >= 4.5 THEN
        INSERT INTO DRIVER_BONUS (DRIVER_ID, BONUS_AMOUNT) VALUES (NEW.DRIVER_ID, 100);
    END IF;
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER payment_confirmation
AFTER INSERT ON PAYMENT
FOR EACH ROW
BEGIN
    INSERT INTO PAYMENT_CONFIRMATION (CUSTOMER_ID, MESSAGE, CONFIRMATION_TIME) VALUES (NEW.CUSTOMER_ID, 'Payment confirmed', NOW());
END //

DELIMITER ;

DELIMITER //

CREATE TRIGGER driver_rating_threshold_alert
AFTER INSERT ON RIDE
FOR EACH ROW
BEGIN
    IF NEW.DRIVER_RATING < 3.0 THEN
        INSERT INTO ADMIN_NOTIFICATION (MESSAGE) VALUES ('Driver rating fell below 3.0: ' || NEW.DRIVER_ID);
    END IF;
END //

DELIMITER ;
